# GP Arranger FAQ

## Does the GP arranger automatically transpose phrases?

Yes. When the arranger evaluates an instrument, it augments the GP program list with global-transpose candidates returned by [`auto_range_programs`](../domain/arrangement/gp/program_utils.py). These candidates are derived from the phrase and the instrument range, and they include octave-aligned shifts when a phrase would otherwise sit outside the playable tessitura. The scorer blends those candidates with the GP winner before running the difficulty and fitness evaluation, so any improvement found by transposing up or down can be selected even if the original melody already sits inside the raw range. The arranger preview seeds this process with the UI hint (the "preferred register shift") without mutating the preview span itself, ensuring the hinted transpose is always considered during GP ranking.

## Why are GP generations clamped at 250 in the UI?

`ArrangerGPSettings.normalized()` applies guard rails for every tunable input so pathological values do not lock up the arranger. Generations are clamped to the range 1–250, population size to 1–640, and related knobs are capped to the population size (log-best entries top out at 320). These limits keep the search responsive in the desktop app and mirror the defaults baked into `GPSessionConfig`. When you dial values above the recommended ceilings (50 generations or 64 population/archive/random programs), the UI surfaces a warning explaining that the run may take substantially longer.

## How can I encourage the GP arranger to try different transpositions?

- **Leave manual transpose at 0 when possible.** The v3 strategy injects automatic `GlobalTranspose` candidates (including the preview hint) whenever no manual transpose is locked in, so clearing the knob lets the GP session consider the widest range of offsets.
- **Adjust the instrument’s preferred range.** Tightening or loosening the preferred span in the preview drawer feeds a new hint into `_auto_register_shift`, which steers the automatically seeded transpose toward the centre of the playable register.
- **Broaden the GP search.** Raising generations, population, or the number of random programs gives the session more opportunities to combine a global shift with other edits. You can also toggle the random seed to diversify the initial population; the warning label will remind you when you exceed the recommended bounds but won’t block the run.
- **Tune penalty weights in the advanced panel.** The “Penalty tuning” sliders let you soften or harden the built-in heuristics—boost the range clamp penalty or melody bias to push phrases away from the edges, raise the melody-shift weight to punish octave jumps, nudge the rhythm-simplify weight upward when you want to discourage `SimplifyRhythm` edits, or increase the fidelity priority when you want melodic accuracy to dominate other goals. The defaults park the range clamp penalty just below the disable threshold (4.9) while the rhythm weight now starts at 5.0, disabling `SimplifyRhythm` unless you dial it back down. Any penalty set to 5.0 or above disables the associated edit entirely: range clamp penalties ≥ 5 skip range-clamped spans altogether (leaving the winning program’s notes outside the instrument range when no clean alternative exists), clamp melody bias ≥ 5 does the same, melody-shift weights ≥ 5 remove `LocalOctave` primitives, rhythm weights ≥ 5 drop `SimplifyRhythm`, and fidelity weights ≥ 5 block both `LocalOctave` and `SimplifyRhythm` edits so only global transposes remain. Values above 1.0 still add melodic surcharges for simplifications, and the GP loop applies the same costs while it evolves programs, so heavy weights keep the raw session winner from flattening short notes. When a low tail keeps the scorer glued to a smaller shift, try easing the melody-shift weight toward 0.1 so uniformly transposed candidates outrank clamp-heavy alternatives, then adjust the rhythm penalty if simplified figures still creep in.

Once a uniformly shifted candidate lands in range it typically wins the fitness race thanks to melody-shift penalties that punish mixed octave clamps, so these levers mostly help the GP session discover that cleaner transposition sooner.

## Why does the arranger stick to +12 even when a +16 shift sounds better?

Instrument limits still apply after the GP loop runs. A uniform +16 semitone shift of the Alto C example lifts the highest E5 in the full track up to G♯6, which exceeds the instrument’s F6 ceiling. During scoring the candidate is therefore range-clamped back to F6, and `_difficulty_sort_key` keeps the cleaner in-range +12 transpose ahead of the clipped alternative. To get the +16 output you either need to widen the instrument range (for example by editing the preferred range in the preview drawer) or pick an instrument whose top note covers the transposed melody—otherwise the arranger will continue to prefer the highest uniform shift that avoids clamping.

If you want to audition the raw GP winner regardless, use the **Apply program** toggle under the GP arranger controls to switch to “Use session winner.” The arranger will render the preview using the exact program that topped the GP archive, while the comparison table and telemetry still reflect the ranked candidate. Flip the toggle back to “Use ranked candidate” to return to the default behaviour that honours the final scoring order.

## How can I share or reuse my GP arranger settings?

The advanced panel now includes **Export GP preset…** and **Import GP preset…** buttons. Export writes the current GP knobs (including penalty weights and the apply-program preference) to a JSON file you can check into source control or share with collaborators. Import reads one of those preset files back in, normalises the contents, and applies the settings immediately so the spinboxes, sliders, and warning label all reflect the imported values.

## What do the preview logs look like during a GP run?

- The preview worker renders the original and arranged clips before the GP session starts, so seeing one or two quick synth renders with `events=0` is normal—they initialise the buffers before any arrangement data is available.
- After the arranger kicks in you should see progress updates begin at `Preparing arrangement…` (0 %), jump to `Running GP arranger…` (10 %), and then emit `Running GP generation X/Y` messages that climb toward 99 %. The final `Arrangement complete` message closes the loop at 100 % once the scoring pass finishes.
- If debug logging is enabled, the `arrange_v3_gp:generation` lines will list the best programs for every generation. Set `GPSessionConfig.log_markdown_generations=True` when you want the same summaries in a Markdown table—the session logger will emit it just after the final winner so you can paste it into bug reports or spreadsheets. The session summary (`arrange_v3_gp:session complete`) will also report the configured generation count, so if it reads `generations=50` the GP loop ran all 50 iterations even if the UI consolidated some progress updates.
